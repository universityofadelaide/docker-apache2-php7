#!/bin/sh
set -e

# Ensure /code/web directory exists, preventing Apache from crashing.
mkdir -p /code/web

# Is the $WEB_PATH set?
if [ -n "${WEB_PATH:+1}" ]; then
  # If it's set, ensure $WEB_PATH starts with a slash.
  WEB_PATH=$(echo ${WEB_PATH} | sed 's#^\([^/]\)#/\1#')

  # Unset $WEB_PATH if it's just a slash. Otherwise Apache does weird things.
  if [ "$WEB_PATH" == "/" ]; then
    unset WEB_PATH
  fi
fi

# If $PUBLIC_DIR is set, symlink it to /shared/public and correct permissions.
if [ -n "${PUBLIC_DIR:+1}" ]; then
  mkdir -p ${PUBLIC_DIR}
  chown -R www-data:www-data /shared/public
  # Only create symlink if it doesn't already exist (and sites/default exists).
  if [ -d /code/web/sites/default ] && [ ! -h /code/web/sites/default/files ]; then
    chmod 0775 /code/web/sites/default/
    ln -sf ${PUBLIC_DIR} /code/web/sites/default/files
    chmod 0555 /code/web/sites/default/
  fi
fi

# If $PRIVATE_DIR is set, ensure it exists and has correct permissions.
if [ -n "${PRIVATE_DIR:+1}" ]; then
  mkdir -p ${PRIVATE_DIR}
  chown -R www-data:www-data ${PRIVATE_DIR}
fi

# If $TMP_DIR is set, ensure it exists and has correct permissions.
if [ -n "${TMP_DIR:+1}" ]; then
  mkdir -p ${TMP_DIR}
  chown -R www-data:www-data ${TMP_DIR}
fi

exec apache2 -D FOREGROUND
